@using BlazorElectronToolbar.Client.Shared.ContextMenu
@using Helpers
@using BlazorElectronToolbar.Shared
@using System.Text.Json;
@inject IJSRuntime JsRuntime
@inject IToolbarCommandControl ToolbarCommandControl
@page "/"

@if (Expanded)
{
    <div class="side-content" id="side-content">
        <button type="button" @onclick="HideInfo" title="Close" class="close-btn"><i class="las la-times-circle la-2x"></i></button>
        <div class="side-content--inner">
            <ElementInfo @ref="ElementInfo" File="RequestedFileInfo" IsAboutDialog="IsAboutDialog" AboutModel="AboutModel" />
        </div>

    </div>
}
<div class="main-content" id="main-content" @oncontextmenu="OnMainRightClick">
    <ElementContainer>
        <div class="content">
            @if (Files.Count > 0)
            {
                foreach (var File in Files)
                {
                    <Element OnContextMenu="ToggleContextMenu" ItemId="@File.FileId" Name="@File.Name" Path="@File.Path"></Element>
                }
            }
        </div>
    </ElementContainer>
</div>

<ContextMenu @ref="ContextMenu" MenuId="menu-1">
    @if (!string.IsNullOrEmpty(ActiveItemId))
    {
        <CMItem OnClick="Run">Run</CMItem>
        <CMItem OnClick="ShowInfo">Show info</CMItem>
        <CMItem OnClick="Remove">Remove</CMItem>
    }
    else
    {
        <CMItem OnClick="ToolbarCommandControl.OpenDevTools">Open DevTools</CMItem>
        <CMItem OnClick="About">About</CMItem>
    }
</ContextMenu>

@code {
    IJSObjectReference ContextMenuModule;
    ContextMenu ContextMenu;

    ElementInfo ElementInfo;
    FileDescriptor RequestedFileInfo;
    bool Expanded = false;

    List<FileDescriptor> Files = new List<FileDescriptor>();
    int CurrentCount = 0;

    string ActiveItemId = null;

    bool IsAboutDialog = false;
    AboutModel AboutModel;

    protected async override Task OnInitializedAsync()
    {
        Files = (await ToolbarCommandControl.LoadFiles())?.ToList() ?? Enumerable.Empty<FileDescriptor>().ToList();
    }

    protected async override Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            ContextMenuModule = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./js/modules/contextmenu.js");
            await ContextMenuModule.InvokeVoidAsync("InitCM", DotNetObjectReference.Create(ContextMenu));
            await JsRuntime.InvokeVoidAsync("ZHelpers.AttachItemDropEvent", DotNetObjectReference.Create(this));
        }
    }

    void OnMainRightClick(MouseEventArgs e)
    {
        Console.WriteLine("Main CM");
        ActiveItemId = null;
        StateHasChanged();
        ContextMenu.UpdatePosition(e.ClientX, e.ClientY);
        ContextMenu.Show();
    }

    void ToggleContextMenu(CMEventArgs e)
    {
        Console.WriteLine("Element CM");
        ActiveItemId = e.ItemId;
        StateHasChanged();
        ContextMenu.UpdatePosition(e.MouseEventArgs.ClientX, e.MouseEventArgs.ClientY);
        ContextMenu.Show();
    }

    [JSInvokable]
    public async void ItemDropHandler(string JsonData)
    {
        var newFiles = JsonSerializer.Deserialize<FileDescriptor[]>(JsonData);

        for (int i = 0; i < newFiles.Length; i++)
        {
            if (!Files.Any(f => f.Name.Equals(newFiles[i].Name, StringComparison.InvariantCultureIgnoreCase)))
            {
                newFiles[i].FileId = Guid.NewGuid().ToString();
                Files.Add(newFiles[i]);
            }
        }

        if (Files.Count != CurrentCount)
        {
            await ToolbarCommandControl.SaveChanges(Files);
            CurrentCount = Files.Count;
            StateHasChanged();
        }
    }

    async Task Run()
    {
        var File = Files.Where(f => f.FileId == ActiveItemId).FirstOrDefault();

        if (File != null)
        {
            var res = await ToolbarCommandControl.Run(File.Path);

            if (!res) //Make an error dialog instead
            {
                throw new Exception($"App {File.Name} failed to start!");
            }
        }
    }

    async Task ShowInfo()
    {
        RequestedFileInfo = Files.Where(f => f.FileId.Equals(ActiveItemId, StringComparison.InvariantCultureIgnoreCase)).FirstOrDefault();

        if (RequestedFileInfo != null)
        {
            IsAboutDialog = false;
            await ToolbarCommandControl.Expand();
            await Task.Delay(200);

            Expanded = true;
            StateHasChanged();
        }
    }

    async Task HideInfo()
    {
        Expanded = false;
        StateHasChanged();
        await ToolbarCommandControl.Retract();
    }

    async Task Remove()
    {
        var item = Files.Where(f => f.FileId.Equals(ActiveItemId, StringComparison.InvariantCultureIgnoreCase)).FirstOrDefault();

        if (item != null)
        {
            Files.Remove(item);
            await ToolbarCommandControl.Remove(ActiveItemId);
            await ToolbarCommandControl.SaveChanges(Files);
            CurrentCount = Files.Count;
            StateHasChanged();
        }
    }

    async Task About()
    {
        var aboutData = await ToolbarCommandControl.AboutDialog();

        if (aboutData != null)
        {
            AboutModel = aboutData;
            IsAboutDialog = true;

            await ToolbarCommandControl.Expand();
            await Task.Delay(200);

            Expanded = true;
            StateHasChanged();
        }
    }
}
